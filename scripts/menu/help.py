#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
帮助文本模块

提供各功能的详细说明文本。
"""

from typing import Dict

# ============================================================================
# 帮助文本定义
# ============================================================================

HELP_TEXTS: Dict[str, str] = {
    "main": """
╔══════════════════════════════════════════════════════════════╗
║                     SR-EEG 实验助手帮助                       ║
╚══════════════════════════════════════════════════════════════╝

SR-EEG 是一个基于随机共振（Stochastic Resonance）的脑电信号分类
实验平台。本助手提供交互式菜单，帮助您配置和运行实验。

主要功能:
─────────────────────────────────────────────────────────────────
[1] 快速开始    使用当前配置立即开始训练
[2] 实验配置    修改模型、数据集、SR参数、训练参数等
[3] 运行实验    选择不同的训练模式（标准/LOSO/批量）
[4] 分析可视化  对已训练模型进行分析并生成图表
[5] 帮助        查看详细使用说明

快捷键:
─────────────────────────────────────────────────────────────────
• 输入数字选择菜单项
• 按回车确认（部分选项有默认值）
• 输入 0 返回上级菜单或退出
• Ctrl+C 可随时取消当前操作

配置持久化:
─────────────────────────────────────────────────────────────────
您的配置会自动保存到 config.json 文件，下次启动时自动加载。
""",

    "quick_start": """
═══════════════════════════════════════════════════════════════
  快速开始
═══════════════════════════════════════════════════════════════

快速开始会使用当前保存的配置直接运行一次完整的实验流程，包括:

1. 模型训练 - 使用选定的模型和数据集进行训练
2. 训练曲线 - 生成训练过程的 loss/accuracy 曲线
3. 模型分析 - 进行噪声扫描分析
4. 可视化   - 生成混淆矩阵、性能曲线等图表

如果您是第一次使用，建议先通过「实验配置」菜单检查和修改配置。
""",

    "loso": """
═══════════════════════════════════════════════════════════════
  LOSO 交叉验证
═══════════════════════════════════════════════════════════════

什么是 LOSO？
─────────────────────────────────────────────────────────────────
LOSO (Leave-One-Subject-Out) 即「留一被试法」，是一种常用的
交叉验证策略，用于评估模型的跨被试泛化能力。

工作原理:
─────────────────────────────────────────────────────────────────
假设数据集中有 N 个被试（BCI2a 有 9 个被试）：

  Fold 1: 被试 1 做测试，被试 2-9 做训练
  Fold 2: 被试 2 做测试，被试 1,3-9 做训练
  Fold 3: 被试 3 做测试，被试 1-2,4-9 做训练
  ...
  Fold 9: 被试 9 做测试，被试 1-8 做训练

最终性能为 9 个 Fold 的平均值。

运行模式:
─────────────────────────────────────────────────────────────────
• 运行单个 Fold: 只用指定的一个被试做测试集，适合快速验证
• 运行全部 Folds: 完整评估，需要运行 N 次训练（较慢但完整）

注意事项:
─────────────────────────────────────────────────────────────────
• 使用 LOSO 数据集配置（bci2a_loso / bci2b_loso）
• 运行全部 Folds 需要较长时间，请确保计算资源充足
""",

    "batch": """
═══════════════════════════════════════════════════════════════
  批量实验
═══════════════════════════════════════════════════════════════

批量实验允许您自动运行多种配置组合，适合系统性地比较不同设置。

全组合模式:
─────────────────────────────────────────────────────────────────
自动遍历所有可能的参数组合:
  • 2 个模型 × 2 个数据集 × 3 个机制 × 5 个噪声 = 60 个实验

⚠️ 警告: 全组合模式会运行大量实验，请确保有足够的时间和计算资源。

自定义模式:
─────────────────────────────────────────────────────────────────
选择要遍历的参数子集，例如:
  • 只选择 1 个模型、2 个噪声类型 → 1 × 1 × 3 × 2 = 6 个实验

结果保存:
─────────────────────────────────────────────────────────────────
每个实验的结果会保存在独立的目录:
  ./results/{model}_{dataset}_{mechanism}_{noise}/
""",

    "sr_mechanism": """
═══════════════════════════════════════════════════════════════
  随机共振 (SR) 机制
═══════════════════════════════════════════════════════════════

随机共振是一种「噪声增强信号」的现象，在特定条件下，添加适量
的噪声可以提高信号检测能力。

可用机制:
─────────────────────────────────────────────────────────────────

[Additive] 加性随机共振
  • 直接将噪声加到输入信号上
  • 公式: y = x + σ·n，其中 n 为噪声
  • 最简单直接的 SR 实现

[Bistable] 双稳态随机共振
  • 使用双势阱系统
  • 信号和噪声驱动粒子在两个稳态之间跳跃
  • 经典的 SR 模型

[Tristable] 三稳态随机共振
  • 三势阱系统，增加一个中间稳态
  • 可能提供更丰富的动态特性
  • 实验性质的扩展机制

噪声类型:
─────────────────────────────────────────────────────────────────
• Gaussian    - 高斯白噪声，最常用
• Uniform     - 均匀分布噪声
• Alpha-Stable - Alpha 稳定分布，可模拟重尾特性
• Poisson     - 泊松噪声，适合脉冲类
• Colored     - 有色噪声（粉噪声），具有频率依赖性
""",

    "gpu": """
═══════════════════════════════════════════════════════════════
  GPU 设置
═══════════════════════════════════════════════════════════════

GPU 选择:
─────────────────────────────────────────────────────────────────
• 系统会自动检测可用的 NVIDIA GPU
• 您可以选择使用哪个 GPU 进行训练
• 也可以选择 CPU 模式（不推荐，速度较慢）

多 GPU:
─────────────────────────────────────────────────────────────────
当前版本仅支持单 GPU 训练。如需使用多 GPU，请直接修改命令行参数:
  trainer.devices=[0,1]  # 使用 GPU 0 和 1

显存不足:
─────────────────────────────────────────────────────────────────
如果遇到显存不足 (CUDA out of memory) 错误，可以尝试:
  1. 减小 Batch Size（如 32 → 16）
  2. 选择更简单的模型（如 EEGNet 代替 Conformer）
  3. 关闭其他占用 GPU 的程序
""",

    "training_params": """
═══════════════════════════════════════════════════════════════
  训练参数
═══════════════════════════════════════════════════════════════

Epochs (训练轮数):
─────────────────────────────────────────────────────────────────
• 默认: 50
• 范围: 1-1000
• 更多轮数可能提高性能，但也增加过拟合风险
• 配合 Early Stopping 使用效果更好

Batch Size (批大小):
─────────────────────────────────────────────────────────────────
• 默认: 32
• 可选: 8, 16, 32, 64, 128, 256
• 更大的 batch 训练更稳定但需要更多显存
• 更小的 batch 有正则化效果但训练更慢

Learning Rate (学习率):
─────────────────────────────────────────────────────────────────
• 默认: 0.001
• 范围: 1e-6 到 1.0
• 太大会导致训练不稳定
• 太小会导致收敛缓慢

Early Stopping Patience:
─────────────────────────────────────────────────────────────────
• 默认: 10
• 如果验证集性能连续 N 轮没有提升，自动停止训练
• 防止过拟合，节省训练时间
""",

    "analysis": """
═══════════════════════════════════════════════════════════════
  分析与可视化
═══════════════════════════════════════════════════════════════

模型分析:
─────────────────────────────────────────────────────────────────
• 噪声扫描: 测试不同噪声强度下的模型性能
• 找出最佳噪声强度，验证 SR 效应

可视化图表:
─────────────────────────────────────────────────────────────────
• 训练曲线: Loss 和 Accuracy 随训练轮数的变化
• 混淆矩阵: 各类别的分类情况
• 噪声-性能曲线: 展示 SR 效应的核心图表

输出目录:
─────────────────────────────────────────────────────────────────
分析结果保存在:
  ./results/{实验名}/
    ├── analysis_results.json    # 分析结果数据
    └── figures/
        ├── confusion_matrix.png  # 混淆矩阵
        ├── noise_scan.png        # 噪声扫描曲线
        └── training_curves.png   # 训练曲线
"""
}


def show_help(topic: str = "main"):
    """
    显示帮助文本
    
    Args:
        topic: 帮助主题
    """
    text = HELP_TEXTS.get(topic, HELP_TEXTS["main"])
    print(text)
    input("\n  按回车键返回...")


def show_help_menu():
    """显示帮助菜单"""
    from .ui import print_menu_header, get_choice
    
    while True:
        print_menu_header("帮助", "ℹ️")
        
        print("  [1] 总体介绍")
        print("  [2] 快速开始说明")
        print("  [3] LOSO 交叉验证")
        print("  [4] 批量实验")
        print("  [5] SR 机制与噪声")
        print("  [6] GPU 设置")
        print("  [7] 训练参数")
        print("  [8] 分析与可视化")
        print()
        print("  [0] ← 返回主菜单")
        print()
        
        choice = get_choice("请选择帮助主题: ", 
                           ["0", "1", "2", "3", "4", "5", "6", "7", "8"])
        
        topic_map = {
            "1": "main",
            "2": "quick_start",
            "3": "loso",
            "4": "batch",
            "5": "sr_mechanism",
            "6": "gpu",
            "7": "training_params",
            "8": "analysis"
        }
        
        if choice == "0":
            return
        
        show_help(topic_map.get(choice, "main"))