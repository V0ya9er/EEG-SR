#!/bin/bash
# ============================================
# AutoDL ç¯å¢ƒåˆå§‹åŒ–è„šæœ¬
# ============================================
# 
# ä½¿ç”¨æ–¹å¼:
#   chmod +x scripts/autodl_setup.sh
#   ./scripts/autodl_setup.sh
#
# è¯¥è„šæœ¬ä¼š:
#   1. æ£€æŸ¥ GPU é…ç½®
#   2. å®‰è£… Python ä¾èµ–
#   3. é¢„ä¸‹è½½ EEG æ•°æ®é›†åˆ° SSD
#   4. éªŒè¯å®‰è£…
#

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              AutoDL ç¯å¢ƒåˆå§‹åŒ–                             â•‘"
echo "â•‘              EEG-SR éšæœºå…±æŒ¯å®éªŒ                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ============================================
# 1. æ£€æŸ¥ GPU
# ============================================
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ [1/5] æ£€æŸ¥ GPU é…ç½®                                         â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
nvidia-smi --query-gpu=index,name,memory.total --format=csv
GPU_COUNT=$(nvidia-smi -L | wc -l)
echo ""
echo "âœ“ æ£€æµ‹åˆ° ${GPU_COUNT} ä¸ª GPU"

# ============================================
# 2. åˆ›å»ºæ•°æ®ç›®å½•ï¼ˆä½¿ç”¨ SSDï¼‰
# ============================================
echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ [2/5] é…ç½®æ•°æ®ç›®å½• (SSD)                                    â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

# AutoDL SSD è·¯å¾„
SSD_PATH="/root/autodl-tmp"
DATA_PATH="${SSD_PATH}/data"
MNE_PATH="${SSD_PATH}/mne_data"

mkdir -p "$DATA_PATH"
mkdir -p "$MNE_PATH"

# è®¾ç½® MNE æ•°æ®ç›®å½•ç¯å¢ƒå˜é‡
export MNE_DATA="$MNE_PATH"
echo "export MNE_DATA=$MNE_PATH" >> ~/.bashrc

# åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
if [ -d "$HOME/mne_data" ] && [ ! -L "$HOME/mne_data" ]; then
    echo "ç§»åŠ¨ç°æœ‰æ•°æ®åˆ° SSD..."
    mv ~/mne_data/* "$MNE_PATH/" 2>/dev/null || true
    rm -rf ~/mne_data
fi
ln -sf "$MNE_PATH" ~/mne_data

echo "âœ“ æ•°æ®ç›®å½•: $DATA_PATH"
echo "âœ“ MNE æ•°æ®ç›®å½•: $MNE_PATH"

# ============================================
# 3. å®‰è£…ä¾èµ–
# ============================================
echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ [3/5] å®‰è£… Python ä¾èµ–                                      â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

# å‡çº§ pip
pip install --upgrade pip -q

# å®‰è£…é¡¹ç›®ä¾èµ–
pip install -r requirements.txt -q

echo "âœ“ Python ä¾èµ–å®‰è£…å®Œæˆ"

# ============================================
# 4. é¢„ä¸‹è½½æ•°æ®é›†
# ============================================
echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ [4/5] é¢„ä¸‹è½½ EEG æ•°æ®é›†                                     â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "è¿™å¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿ..."
echo ""

python -c "
import os
os.environ['MNE_DATA'] = '$MNE_PATH'

from braindecode.datasets import MOABBDataset

print('ğŸ“¥ ä¸‹è½½ BCI IV 2a æ•°æ®é›† (9 è¢«è¯•)...')
try:
    ds = MOABBDataset('BNCI2014_001', subject_ids=[1,2,3,4,5,6,7,8,9])
    print('   âœ“ BCI IV 2a ä¸‹è½½å®Œæˆ')
except Exception as e:
    print(f'   âš  ä¸‹è½½å¤±è´¥: {e}')

print('')
print('ğŸ“¥ ä¸‹è½½ BCI IV 2b æ•°æ®é›† (9 è¢«è¯•)...')
try:
    ds = MOABBDataset('BNCI2014_004', subject_ids=[1,2,3,4,5,6,7,8,9])
    print('   âœ“ BCI IV 2b ä¸‹è½½å®Œæˆ')
except Exception as e:
    print(f'   âš  ä¸‹è½½å¤±è´¥: {e}')
"

echo ""
echo "âœ“ æ•°æ®é›†å‡†å¤‡å®Œæˆ"

# ============================================
# 5. éªŒè¯å®‰è£…
# ============================================
echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ [5/5] éªŒè¯å®‰è£…                                              â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

python -c "
import torch
import pytorch_lightning as pl
import hydra

print(f'PyTorch ç‰ˆæœ¬:     {torch.__version__}')
print(f'CUDA å¯ç”¨:        {torch.cuda.is_available()}')
print(f'CUDA è®¾å¤‡æ•°:      {torch.cuda.device_count()}')
for i in range(torch.cuda.device_count()):
    name = torch.cuda.get_device_name(i)
    mem = torch.cuda.get_device_properties(i).total_memory / 1024**3
    print(f'  GPU {i}: {name} ({mem:.1f} GB)')

print(f'Lightning ç‰ˆæœ¬:   {pl.__version__}')
print(f'Hydra ç‰ˆæœ¬:       {hydra.__version__}')

# æµ‹è¯•é¡¹ç›®æ¨¡å—
from src.data.fold_utils import FoldSplitter
from src.data.loso_datamodule import LOSODataModule

print('')
print('ğŸ“‹ FoldSplitter æµ‹è¯• (3 æŠ˜):')
splitter = FoldSplitter([1,2,3,4,5,6,7,8,9], n_folds=3)
splitter.print_allocation()

print('')
print('âœ… æ‰€æœ‰ä¾èµ–å®‰è£…æ­£ç¡®!')
"

# ============================================
# å®Œæˆ
# ============================================
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              âœ… åˆå§‹åŒ–å®Œæˆ!                                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“– ä½¿ç”¨ç¤ºä¾‹:"
echo ""
echo "  # å•æŠ˜è®­ç»ƒ (é»˜è®¤é…ç½®)"
echo "  python src/loso_train.py dataset=bci2a_loso"
echo ""
echo "  # æŒ‡å®šæŠ˜å’Œå™ªå£°å¼ºåº¦"
echo "  python src/loso_train.py dataset=bci2a_loso dataset.fold_id=2 sr.mechanism.intensity=0.5"
echo ""
echo "  # å¤šæŠ˜æ‰¹é‡è¿è¡Œ (Hydra multirun)"
echo "  python src/loso_train.py --multirun dataset.fold_id=1,2,3"
echo ""
echo "  # å¤š GPU å¹¶è¡Œå®éªŒ (æ¨è)"
echo "  python scripts/run_sweep.py --gpus 0,1,2,3"
echo ""
echo "  # ç»“æœåˆ†æ"
echo "  python scripts/loso_analyze.py --results-dir . --verbose"
echo ""